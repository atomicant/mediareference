<?php
// $Id: $

/**
 * @file
 * Defines a widget for referencing media content from another. With multiple
 * select a multiple upload features and AJAX interface.
 *
 * IMPORTANT! Javascript for admin UI is needed!
 *
 * @author
 * Vojtech Kusy <wojtha@gmail.com>, http://vojtechkusy.com
 *
 */

//=========================================
//    CONFIGURATION
//=========================================

// Image
define('MEDIAREF_IMAGE_TYPE', 'image');
define('MEDIAREF_IMAGE_THUMBNAIL', 'field_image');
define('MEDIAREF_IMAGE_FIELDS', 'title|description|link');

// Video
define('MEDIAREF_VIDEO_TYPE', 'video');
define('MEDIAREF_VIDEO_THUMBNAIL', 'field_image');
define('MEDIAREF_VIDEO_FIELDS', 'title|description');

// Slideshow
define('MEDIAREF_SLIDESHOW_TYPE', 'slideshow');
define('MEDIAREF_SLIDESHOW_THUMBNAIL', 'field_image');
define('MEDIAREF_SLIDESHOW_FIELDS', 'title|description|link|color');

// Imagecache
define('MEDIAREF_IMAGECACHE_THUMB_PROFILE', 'mediareference_thumbs');

//=========================================
//    DRUPAL HOOKS
//=========================================


/**
 * Implementation of hook_menu().
 */
function mediareference_menu() {
  $items = array();

  // arguments: type/field/id/action
  $items['mediareference_js/%/%/%/%'] = array(
    'title' => 'Mediareference Ahah Controller' ,
    'page callback' => 'mediareference_widget_js' ,
    'page arguments' => array(1, 2, 3, 4),
    'access arguments' => array('access content') ,
    'type' => MENU_CALLBACK
  );
  $items['mediabrowser'] = array(
    'title' => 'Mediabrowser',
    'page callback' => 'mediareference_browser' ,
    'access arguments' => array('access content') ,
    'type' => MENU_CALLBACK
  );
  $items['lightframe/close'] = array(
    'title' => 'Close Lightframe',
    'page callback' => 'mediareference_lightframe_close_callback' ,
    'access arguments' => array('access content') ,
    'type' => MENU_CALLBACK
  );

  return $items;
}

function mediareference_form_alter(&$form, $form_state, $form_id) {
  // Here we simply want to install a form after_build callback.
  // if (isset($form['type']) && isset($form['#node']) && $form['type']['#value'] .'_node_form' == $form_id) {
  if (strpos($_GET['q'], 'lightframe') !== FALSE) {
    if (!isset($form['#after_build'])) {
      $form['#after_build'] = array();
    }
    $form['#after_build'][] = 'mediareference_lightframe_form_after_build';
  }

  /*if ($form_id == 'views_exposed_form') {
    $form['filters'] = array(
      '#type' => 'fieldset',
      '#title' => 'Filters',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
    );

    foreach ($form as $key => $element) {
      if ($key{0} === '#' || in_array($key, array('form_id', 'form_build_id', 'form_token', 'filters'))) {
        continue;
      }
      $form['filters'][$key] = $element;
      unset($form[$key]);
    }
    dpm($form);
  }*/

}

function mediareference_lightframe_form_after_build($form, &$form_state) {
  mediareference_lightframe_child_js();
  return $form;
}

/**
* Implementation of hook_theme().
*/
function mediareference_theme() {
  return array(
    // Theme for the widget.
    'mediareference_widget' => array(
      'arguments' => array('element' => NULL),
    ),
  );
}

/**
 * Implementation of hook_imagecache_default_presets()
 */
function mediareference_imagecache_default_presets() {
  $presets = array();
  $presets['mediareference_thumbs'] = array(
    'presetname' => 'mediareference_thumbs',
    'actions' => array(
      0 => array(
        'weight' => '0',
        'module' => 'imagecache',
        'action' => 'imagecache_scale_and_crop',
        'data' => array(
          'width' => '90',
          'height' => '90'
        )
      )
    )
  );
}

//=========================================
//    CCK FIELD
//=========================================

/**
 * Implementation of CCK hook_field_settings()
 */
function mediareference_field_info() {
  return array(
    'mediareference' => array(
      'label' => t('Media reference'),
      'description' => t('Stores an nodereference, custom title, description, link and color style.'),
    )
  );
}

/**
 * Implementation of CCK hook_field_settings()
 */
function mediareference_field_settings($op, $field) {
  switch($op) {
    case 'database columns':
      $columns = array();
      $columns += nodereference_field_settings('database columns', $field);
      $columns['title'] = array('type' => 'varchar', 'length' => 255, 'not null' => FALSE, 'sortable' => TRUE, 'default' => '');
      $columns['description'] = array('type' => 'text', 'not null' => FALSE, 'sortable' => TRUE);
      $columns['link'] = array('type' => 'varchar', 'length' => 255, 'not null' => FALSE, 'sortable' => FALSE, 'default' => '');
      $columns['colour'] = array('type' => 'varchar', 'length' => 255, 'not null' => FALSE, 'sortable' => FALSE, 'default' => '');
      return $columns;

    case 'form':
      $form = array();
      $form += nodereference_field_settings('form', $field);
      $form += array('description_text_processing' => array(
        '#type' => 'radios',
        '#title' => t('Text processing for Description'),
        '#default_value' => is_numeric($field['description_text_processing']) ? $field['description_text_processing'] : 0,
        '#options' => array(
            0 => t('Plain text'),
            1 => t('Filtered text (user selects input format)')
          ),
      ));
      return $form;

    case 'save':
      $settings = nodereference_field_settings('save', $field);
      $settings[] = 'description_text_processing';
      return $settings;

     case 'views data':
      return nodereference_field_settings('views data', $field);
  }
}

/**
 * Implementation of CCK hook_field()
 */
function mediareference_field($op, $node, $field, &$items, $teaser, $page) {

  switch ($op) {
    case 'sanitize':
      foreach ($items as $delta => $item) {
        unset($item['actions']);
        foreach ($item as $col => $data) {
          // process description field
          if ($col === 'description') {
            $is_plain = empty($field['description_text_processing']);
            if ($is_plain) {
              $data = check_plain($data);
            }
            else {
              $check_access = is_null($node) || (isset($node->build_mode) && $node->build_mode == NODE_BUILD_PREVIEW);
              $data = check_markup($data, $item['format'], $check_access);
            }
          }

          $items[$delta]['safe_' . $col] = check_plain($data);
        }
      }
    break;

    case 'validate':
      if (is_array($items)) {
        foreach ($items as $delta => $item) {
          if ($item['link'] != '' && !valid_url(trim($item['link']))) {
            form_set_error($field['field_name'],t('Link "%url" is not a valid link.', array('%url' => $item['link'])));
          }
        }
     }
     break;
  }

  // provide all operations also on nodereference field
  nodereference_field($op, $node, $field, $items, $teaser, $page);
}

/**
 * Implementation of CCK hook_content_is_empty()
 */
function mediareference_content_is_empty($item, $field) {
  return nodereference_content_is_empty($item, $field);
}

//=========================================
//    CCK WIDGET
//=========================================

/**
 * Implementation of CCK hook_widget_info()
 */
function mediareference_widget_info() {
  return array(
    'mediareference_widget' => array(
      'label' => t('Mediareference'),
      'field types' => array('mediareference'),
      'multiple values' => CONTENT_HANDLE_CORE,
      'callbacks' => array('default value' => CONTENT_CALLBACK_CUSTOM),
      'description' => t('An edit widget for media nodereference fields that allows upload/preview of the media content and its description.' ),
    ),
  );
}

/**
 * Implementation of FAPI hook_elements()
 */
function mediareference_elements() {

  $elements = array(
    'mediareference_widget' => array(
      '#input' => TRUE,
      '#delta' => 0,
      '#process' => array('mediareference_widget_process'),
      '#autocomplete_path' => FALSE,
    )
  );

  return $elements;
}

/**
 * Implementation of hook_widget()
 */
function mediareference_widget(&$form, &$form_state, $field, $items, $delta = 0) {
  // Value callback taken from nodereference_widget - type: nodereference_autocomplete.
  $element = array(
    '#type' => $field['widget']['type'],
    '#default_value' => isset($items[$delta]) ? $items[$delta] : NULL,
    '#after_build' => array('mediareference_widget_after_build'),
  );

  return $element;
}

/**
 * After build FAPI form builder
 *
 * We use after build handler because it is load always, even when form is loaded from cache.
 */
function mediareference_widget_after_build($form, &$form_state) {
  static $added = FALSE;

  if (!$added) {
    dialog_add_js();
    $path = drupal_get_path('module', 'mediareference');
    drupal_add_css($path .'/mediareference.css');
    drupal_add_js($path .'/mediareference.js');

    $added = TRUE;
  }

  return $form;
}

/**
 * Implementation of hook_widget_settings()
 */
function mediareference_widget_settings($op, $widget) {
  switch ($op) {
    case 'form':
      $form = array();

      $rows = (isset($widget['rows']) && is_numeric($widget['rows'])) ? $widget['rows'] : 5;
      $form['rows'] = array(
        '#type' => 'textfield',
        '#title' => t('Number of rows in Description field'),
        '#default_value' => $rows,
        '#element_validate' => array('_text_widget_settings_row_validate'),
        '#required' => TRUE,
        '#weight' => 8,
      );

      $cols = (isset($widget['cols']) && is_numeric($widget['cols'])) ? $widget['cols'] : 40;
      $form['cols'] = array(
        '#type' => 'textfield',
        '#title' => t('Number of columns in Description field'),
        '#default_value' => $cols,
        '#element_validate' => array('_text_widget_settings_row_validate'),
        '#required' => TRUE,
        '#weight' => 9,
      );
      return array_merge($form, nodereference_widget_settings('form', $widget));

    case 'save':
      $settings = array();
      $settings[] = 'rows';
      $settings[] = 'cols';
      return array_merge($settings, nodereference_widget_settings('save', $widget));
  }
}

/**
 * Process of our FAPI elements/widget
 */
function mediareference_widget_process($element, $edit, &$form_state, $form) {

  $defaults = $element['#default_value'];
  $field = content_fields($element['#field_name'], $element['#type_name']);

  $preview = '';

  if (empty($defaults['nid'])) {
    $preview = 'none <em>(use Browse button to attach some media)</em>';
    $element['#prefix'] = '<div class="mediareference empty">';
    $element['#suffix'] = '</div>';
  }
  else {

    if (empty($defaults['thumbnail']) || empty($defaults['title']) || empty($defaults['type'])) {
      $node = node_load(array('nid' => $defaults['nid']));
      $defaults['type'] = !empty($defaults['type']) ? $defaults['type'] : $node->type;
      $defaults['title'] = !empty($defaults['title']) ? $defaults['title'] : $node->title;
    }

    $type = $defaults['type'];
    $definition = '';
    $thumb_field = '';
    switch ($type) {
      case MEDIAREF_IMAGE_TYPE:
        $definition = MEDIAREF_IMAGE_FIELDS;
        $thumb_field = MEDIAREF_IMAGE_THUMBNAIL;
        break;
      case MEDIAREF_VIDEO_TYPE:
        $definition = MEDIAREF_VIDEO_FIELDS;
        $thumb_field = MEDIAREF_VIDEO_THUMBNAIL;
        break;
      case MEDIAREF_SLIDESHOW_TYPE:
        $definition = MEDIAREF_SLIDESHOW_FIELDS;
        $thumb_field = MEDIAREF_SLIDESHOW_THUMBNAIL;
        break;
    }

    if (empty($defaults['thumbnail'])) {
      $defaults['thumbnail'] = $node->{$thumb_field}[0]['filepath'];
    }
    $preview = theme('imagecache', MEDIAREF_IMAGECACHE_THUMB_PROFILE, $defaults['thumbnail']);

    $element['#prefix'] = '<div class="mediareference '. $type .'">';
    $element['#suffix'] = '</div>';

    $element['type'] = array(
      '#type' => 'hidden',
      '#value' => $defaults['type'],
    );

    $element['thumbnail'] = array(
      '#type' => 'hidden',
      '#value' => $defaults['thumbnail'],
    );

    $element['nid'] = array(
      '#type' => 'hidden',
      '#value' => $defaults['nid'],
    );

    if (strpos($definition, 'title') !== FALSE) {
      $element['title'] = array(
        '#title' => t('Title'),
        '#type' => 'textfield',
        '#default_value' => $defaults['title'],
        '#weight' => 1,
      );
    }

    if (strpos($definition, 'link') !== FALSE) {
      $element['link'] = array(
        '#title' => t('Link'),
        '#type' => 'textfield',
        '#default_value' => $defaults['link'],
        '#weight' => 2,
      );
    }

    if (strpos($definition, 'color') !== FALSE) {
      $element['color'] = array(
        '#title' => t('Color'),
        '#type' => 'textfield',
        '#default_value' => $defaults['color'],
        '#weight' => 3,
      );
    }

    if (strpos($definition, 'description') !== FALSE) {
      $element['description'] = array(
        '#title' => t('Description'),
        '#type' => 'textarea',
        '#rows' => $field['widget']['rows'],
        '#cols' => $field['widget']['cols'],
        '#default_value' => $defaults['description'],
        '#weight' => 4,
      );

      if (! empty($field['description_text_processing'])) {
        $filter = isset($defaults['format']) ? $defaults['format'] : FILTER_FORMAT_DEFAULT;
        $parents = array_merge($element['#parents'], array('format'));
        $element['format'] = filter_form($filter, 5, $parents);
      }
    }
  }

  $element['preview'] = array(
    '#value' => '<div><strong>Preview:</strong> ' . $preview .'</div>',
    '#weight' => -1,
  );

  $element['actions'] = array(
    '#weight' => 6,
  );

  $field_name_css = str_replace('_', '-', $element['#field_name']);

  $element['actions']['remove'] = array(
    '#type' => 'button',
    '#value' => t('Remove'),
    '#ahah' => array(
      'path' => 'mediareference_js/'. $element['#type_name'] .'/'. $element['#field_name'] .'/'. $element['#delta'] . '/remove',
      'wrapper' => $field_name_css .'-items',
      'method' => 'replace',
      'effect' => 'fade',
    ),
  );

  $element['actions']['browse'] = array(
    '#type' => 'button',
    '#value' => t('Browse'),
    '#ahah' => array(
      'path' => 'mediareference_js/'. $element['#type_name'] .'/'. $element['#field_name'] .'/'. $element['#delta'] . '/update',
      'wrapper' => $field_name_css .'-items',
      'method' => 'replace',
      'effect' => 'fade',
    ),
    '#attributes' => array('class' => 'mediareference-browse-button'),
  );

  // dpm($element);

  return $element;
}

/**
 * Implementation of hook theme_WIDGET()
 */
function theme_mediareference_widget(&$element) {
  return theme('form_element', $element, $element['#children']);
}

//=====================================
//   MENU CALLBACKS
//=====================================

function mediareference_widget_js($type_name, $field_name, $delta_action, $action) {

  $field = content_fields($field_name, $type_name);

  // Add the new elements to the stored form. Without adding the element
  // to the form, Drupal is not aware of this new elements existence and
  // will not process it. We retreive the cached form, add the element,
  // and resave.
  $form_build_id = $_POST['form_build_id'];
  $form_state = array('submitted' => FALSE);
  $form = form_get_cache($form_build_id, $form_state);

  // The form that we get from the cache is unbuilt. We need to build it so that
  // _value callbacks can be executed and $form_state['values'] populated.
  // We only want to affect $form_state['values'], not the $form itself
  // (built forms aren't supposed to enter the cache) nor the rest of $form_data,
  // so we use copies of $form and $form_data.
  $form_copy = $form;
  $form_state_copy = $form_state;
  $form_copy['#post'] = array();
  form_builder($_POST['form_id'], $form_copy, $form_state_copy);
  // Just grab the data we need.
  $form_state['values'] = $form_state_copy['values'];
  unset($form_copy, $form_state_copy);
  // Reset cached ids, so that they don't affect the actual form we output.
  form_clean_id(NULL, TRUE);

  // Sort the $form_state['values'] we just built *and* the incoming $_POST data
  // according to d-n-d reordering.
  $form_state['values'][$field_name] = mediareference_filter_children($form[$field_name]);
  foreach ($_POST[$field_name] as $delta => $item) {
    $form_state['values'][$field_name][$delta]['_weight'] = $item['_weight'];
  }
  $form_state['values'][$field_name] = _content_sort_items($field, $form_state['values'][$field_name]);
  $_POST[$field_name] = _content_sort_items($field, $_POST[$field_name]);

  if ($action == 'remove') {
    unset($form[$field_name][$delta_action]);
    unset($form_state['values'][$field_name][$delta_action]);
    unset($_POST[$field_name][$delta_action]);

    // reindex form ie. 1,2,4 => 1,2,3
    $items = mediareference_filter_children($form[$field_name]);
    $new_key = 0;
    $bak = array();
    foreach ($items as $old_key => $item) {
      if ($old_key != $new_key) {
        $bak = $form[$field_name][$old_key];
        unset($form[$field_name][$old_key]);
        $form[$field_name][$new_key] = $bak;

        $bak = $form_state['values'][$field_name][$old_key];
        unset($form_state['values'][$field_name][$old_key]);
        $form_state['values'][$field_name][$new_key] = $bak;
      }
      $new_key++;
    }
    unset($bak);

    if (count($items) == 0) {
      module_load_include('inc', 'content', 'includes/content.node_form');
      // Build our new form element for the whole field, asking for one more element.
      $form_state['item_count'] = array($field_name => 0);
      $form_element = content_field_form($form, $form_state, $field);
      $form[$field_name][0] = $form_element[$field_name][0];
    }
  }

  if ($action == 'update') {
    if (isset($_SESSION['lightframe']) && isset($_SESSION['lightframe']['nid']) && ($nid = intval($_SESSION['lightframe']['nid']))) {
      $node = node_load(array('nid' => $nid));
      if ($node) {
        $form_state['values'][$field_name][$delta_action]['nid'] = $nid;
        $form_state['values'][$field_name][$delta_action]['type'] = $node->type;
        $form_state['values'][$field_name][$delta_action]['title'] = $node->title;
        $_POST[$field_name][$delta] = $form_state['values'][$field_name][$delta_action];

        module_load_include('inc', 'content', 'includes/content.node_form');
        $form_element = content_field_form($form, $form_state, $field);
        // Let other modules alter it.
        drupal_alter('form', $form_element, array(), 'mediareference_widget_js');
        $form[$field_name][$delta_action] = $form_element[$field_name][$delta_action];
      }
    }
  }

  // Save rebuilded (but unprocessed!) form back to form cache.
  form_set_cache($form_build_id, $form, $form_state);

  // Rebuild the form, filter only needed elements and render the new output
  $form += array(
    '#post' => $_POST,
    '#programmed' => FALSE,
  );
  $form = form_builder($_POST['form_id'], $form, $form_state);
  $field_form = $form[$field_name];
  unset($field_form['#prefix'], $field_form['#suffix']);

  // If a newly inserted widget contains AHAH behaviors, they normally won't
  // work because AHAH doesn't know about those - it just attaches to the exact
  // form elements that were initially specified in the Drupal.settings object.
  // The new ones didn't exist then, so we need to update Drupal.settings
  // by ourselves in order to let AHAH know about those new form elements.
  $javascript = drupal_add_js(NULL, NULL);
  $output_js = isset($javascript['setting']) ? '<script type="text/javascript">jQuery.extend(Drupal.settings, '. drupal_to_js(call_user_func_array('array_merge_recursive', $javascript['setting'])) .');</script>' : '';

  $output = theme('status_messages');
  $output .= drupal_render($field_form) . $output_js;

  // Using drupal_json() breaks filefield's file upload, because the jQuery
  // Form plugin handles file uploads in a way that is not compatible with
  // 'text/javascript' response type.
  $GLOBALS['devel_shutdown'] =  FALSE;
  print drupal_to_js(array('status' => TRUE, 'data' => $output));
  exit;
}


/**
* Implementation of hook_views_api().
*
* @return array with Views API version.
*/
function mediareference_views_api() {
  return array(
    'api' => 2.0,
    'path' => drupal_get_path('module','mediareference') . '/views',
  );
}

/**
 * Implementation of hook_views_embed_form().
 */
function mediareference_views_embed_form() {
  return array(
    'mediareference_attach_form' => t('Attach reference to content'),
  );
}

//=====================================
//   MENU CALLBACKS
//=====================================

function mediareference_browser() {
  $output = '';

  mediareference_lightframe_child_js();

  $view = views_get_view('mediabrowser');
  $view->override_path = $_GET['q'];
  $view->set_display('default');

  // Get the results.
  $output .= $view->preview();

  return $output;
}

/**
 * Views embed form - "Attach" button
 */
function mediareference_attach_form(&$form_state, $fields) {
  $form = array();

  $form['nid'] = array(
    '#type' => 'hidden',
    '#value' => intval($fields->nid)
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Attach'
  );

  return $form;
}

/**
 * Views embed form submit handler - "Add to context" button
 */
function mediareference_attach_form_submit($form, &$form_state) {
  if ($form_state['values']['op'] == $form_state['values']['submit']) {
    mediareference_lightframe_close($form_state, array('nid' => $form_state['values']['nid']));
  }
}


//=====================================
//   HELPERS
//=====================================

/**
 * Filter children delta elements
 *
 * @param array $element
 * @param bool $attributes
 * @return
 * element children (delta items)
 */
function mediareference_filter_children(&$element, $attributes = FALSE) {
  $children = array();

  if (is_array($element) && count($element)) {
    foreach ($element as $key => $value) {
      if (is_numeric($key) || ($attributes && $key[0] == '#')) {
        $children[$key] = $value;
      }
    }
  }

  return $children;
}

/**
 * Add javascript and stylesheets to the child page.
 */
function mediareference_lightframe_child_js() {
  static $processed = FALSE;
  // Make sure external resources are not included more than once.
  if ($processed) {
    return;
  }
  $processed = TRUE;

  // Disable admin_menu, admin module output and similar modules, which
  // is something child windows don't need.
  module_invoke_all('suppress');

  if (module_exists('onbeforeunload')) {
    onbeforeunload_add_js();
  }

  $module_path = drupal_get_path('module', 'mediareference');
  drupal_add_css($module_path .'/mediareference.css');
  drupal_add_js($module_path .'/mediareference.js');

  // Tell Drupal's theme system to use the Modal Frame template.
  $GLOBALS['lightframe_page_template'] = TRUE;
}

/**
 * Close lightframe modal.
 *
 * @param $args
 *   An optional array of arguments that will be forwarded to the client
 *   side onSubmit callback.
 */
function mediareference_lightframe_close(&$form_state, $args = array()) {
  $form_state['redirect'] = 'lightframe/close';
  $_SESSION['lightframe'] = $args;
}

/**
 * Close lightframe modal menu callback.
 */
function mediareference_lightframe_close_callback() {
  mediareference_lightframe_child_js();
  drupal_add_js('parent.LightframeUpdate();parent.Lightbox.end("forceClose");', 'inline');
  return '';
}

function mediareference_theme_registry_alter(&$theme_registry) {
  if (isset($theme_registry['page']) && isset($theme_registry['page']['theme paths'])) {
    $module_path = drupal_get_path('module', 'mediareference');
    array_unshift($theme_registry['page']['theme paths'], $module_path);
    array_unshift($theme_registry['page']['preprocess functions'], 'mediareference_pre_preprocess_page');
  }
}

/**
 * Preprocess template variables for page.tpl.php - step 1.
 *
 * Performance enhancement: prevent template_preprocess_page() from generating
 * sidebar blocks when a modal frame has been requested.
 */
function mediareference_pre_preprocess_page(&$variables) {
  if (!empty($GLOBALS['lightframe_page_template'])) {
    $variables['show_blocks'] = FALSE;
  }
}

/**
 * Preprocess template variables for page.tpl.php - step 2.
 */
function mediareference_preprocess_page(&$variables) {
  if (!empty($GLOBALS['lightframe_page_template'])) {
    if (!isset($variables['template_files'])) {
      $variables['template_files'] = array();
    }
    $variables['template_files'][] = 'lightframe-page';
  }
}

